import { db } from "../../config/firebase.js";
import bcrypt from "bcrypt";
import { compressImageToBase64 } from "../../utils/imageCompression.js";

export const registerUser = async (req, res) => {
  try {
    // Debug: ver qu√© hay en req.body y req.file
    console.log("üìù Registering new user - req.body:", req.body);
    console.log("üìù req.file:", req.file ? "File present" : "No file");
    
    const { name, lastName, universityId, email, contactNumber, password } = req.body;
    
    // Validar que todos los campos requeridos est√©n presentes
    if (!name || !lastName || !universityId || !email || !contactNumber || !password) {
      return res.status(400).json({
        success: false,
        errors: {
          general: "Todos los campos son requeridos",
          missing: {
            name: !name,
            lastName: !lastName,
            universityId: !universityId,
            email: !email,
            contactNumber: !contactNumber,
            password: !password
          }
        }
      });
    }

    // Convertir archivo de multer a base64 si existe (con compresi√≥n)
    let photoBase64 = null;
    if (req.files && req.files.photo && req.files.photo[0]) {
      const photoFile = req.files.photo[0];
      // Para im√°genes de perfil, usar mayor resoluci√≥n y mejor calidad
      const isSvg = photoFile.mimetype === 'image/svg+xml';
      photoBase64 = await compressImageToBase64(
        photoFile.buffer,
        photoFile.mimetype,
        isSvg ? 512 : 1200, // maxWidth - SVG m√°s peque√±o, fotos normales m√°s grandes
        isSvg ? 512 : 1200, // maxHeight
        95   // quality m√°s alta para mejor calidad
      );
    } else if (req.file) {
      // Fallback para compatibilidad si se usa .single() en alg√∫n lugar
      const isSvg = req.file.mimetype === 'image/svg+xml';
      photoBase64 = await compressImageToBase64(
        req.file.buffer,
        req.file.mimetype,
        isSvg ? 512 : 1200, // maxWidth
        isSvg ? 512 : 1200, // maxHeight
        95   // quality m√°s alta
      );
    }

    // Hash the password
    const saltRounds = 12;
    const hashedPassword = await bcrypt.hash(password, saltRounds);

    // Create user document
    const userData = {
      name: name.trim(),
      lastName: lastName.trim(),
      universityId: parseInt(universityId),
      email: email.toLowerCase().trim(),
      contactNumber: contactNumber.toString(),
      password: hashedPassword, // Now properly hashed
      photo: photoBase64 || "data:image/png;base64,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", // Optional photo from multer
      roles: ["passenger"], // Array de roles, inicializado como pasajero
      currentRole: "passenger", // Rol actual del usuario
      createdAt: new Date(),
      updatedAt: new Date(),
      isActive: true
    };

    // Add user to Firestore
    const userRef = await db.collection("users").add(userData);
    
    console.log("‚úÖ User registered successfully with ID:", userRef.id);

    res.status(201).json({
      success: true,
      message: "User registered successfully",
      userId: userRef.id,
      user: {
        id: userRef.id,
        name: userData.name,
        lastName: userData.lastName,
        universityId: userData.universityId,
        email: userData.email,
        contactNumber: userData.contactNumber,
        photo: userData.photo,
        roles: userData.roles,
        currentRole: userData.currentRole,
        createdAt: userData.createdAt
      }
    });

  } catch (error) {
    console.error("‚ùå User registration error:", error);
    console.error("Error stack:", error.stack);
    res.status(500).json({
      success: false,
      error: "Internal server error during registration",
      details: error.message,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
};

export const uploadUserPhoto = async (req, res) => {
  try {
    const { id } = req.params;
    const { photo } = req.body;

    if (!photo) {
      return res.status(400).json({
        success: false,
        error: "Photo data is required",
      });
    }

    const userRef = db.collection("users").doc(id);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
      return res.status(404).json({
        success: false,
        error: "User not found",
      });
    }

    await userRef.update({
      photo,
      updatedAt: new Date(),
    });

    res.status(200).json({
      success: true,
      message: "Photo uploaded successfully",
    });

  } catch (error) {
    console.error("‚ùå Error uploading photo:", error);
    res.status(500).json({
      success: false,
      error: "Internal server error during photo upload",
      details: error.message,
    });
  }
}